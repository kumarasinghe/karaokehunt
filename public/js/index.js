var currentVideoID,currentVideoTitle,currentVideoImageURL;function deselectResults(){let e=document.querySelectorAll(".result");for(let t=0;t<e.length;++t){e[t].style.opacity=.5}}var sessionData=localStorage.sessionData;if(sessionData.length>0){sessionData=JSON.parse(sessionData);for(let e=0;e<sessionData.length;++e){let t=sessionData[e],o=createSessionElemenet(t[0],t[1],t[2]);document.getElementById("session-list").appendChild(o)}document.getElementById("session-container").style.display="block"}else sessionData=[];let videoPlayer;function showPlayer(){document.getElementById("video").style.height="360px",document.getElementById("result-container").style.height="0"}function hidePlayer(){document.getElementById("video").style.height="0",document.getElementById("result-container").style.height="360px"}topTracks.length&&(document.getElementById("welcomeMessage").style.opacity=1,setTimeout(()=>{document.getElementById("welcomeMessage").style.opacity=0,setTimeout(()=>{document.getElementById("result-container").innerHTML="";for(let e=0;e<topTracks.length;++e){let t=topTracks[e],o=t[0],n=t[1],l="https://img.youtube.com/vi/"+o+"/mqdefault.jpg";document.getElementById("result-container").appendChild(createResultElement(n,l,o))}},1e3)},2500)),window.onYouTubePlayerAPIReady=function(){console.log("Youtube Player Ready!"),videoPlayer=new YT.Player("video")},document.getElementById("btnSearch").onclick=function(){document.getElementById("result-container").innerHTML="",videoPlayer.isPlaying&&(videoPlayer.isPlaying=!1,videoPlayer.stopVideo(),btnStartStop.value="Record",hidePlayer(),stopVoiceRecording());let e="/search?keywords="+document.getElementById("txtSearch").value.replace(" ","%20")+"%20karaoke";httpGETRequest(e,e=>{let t=JSON.parse(e);for(let e=0;e<t.length;++e){let o=t[e];document.getElementById("result-container").appendChild(createResultElement(o.title,o.imageURL,o.videoID))}})};var btnStartStop=document.getElementById("btnStartStop");btnStartStop.onclick=(()=>{1!=btnStartStop.disabled&&(videoPlayer.isPlaying?(videoPlayer.isPlaying=!1,videoPlayer.stopVideo(),btnStartStop.value="Record",hidePlayer(),stopVoiceRecording()):(videoPlayer.isPlaying=!0,videoPlayer.playVideo(),btnStartStop.value="Stop",showPlayer(),startVoiceRecording()))});let voiceAudioBuffer,audioContext=new AudioContext,voiceRecorder=new Recorder(()=>{console.log("Recorder ready!")});function startVoiceRecording(){let e=setInterval(()=>{videoPlayer.getCurrentTime()>0&&(clearInterval(e),voiceRecorder.start(),startVisuaizer(),console.log("Voice recording started!"))},100)}function stopVoiceRecording(){stopVisuaizer(),voiceRecorder.stop((e,t,o)=>{console.log("Voice recording stopped!"),httpGETRequest(e,e=>{audioContext.decodeAudioData(e,e=>{voiceAudioBuffer=e,document.getElementById("btnReplay").disabled=!1,document.getElementById("btnReplay").style.backgroundColor="#4CBB17"},e=>{console.error("Error with decoding audio data"+e.err)})},!0);var n=new FormData;n.append("videoID",currentVideoID),n.append("voiceTrack",t),httpPOSTRequest("/upload",n,e=>{sessionData.push([e,currentVideoTitle,currentVideoImageURL]),localStorage.sessionData=JSON.stringify(sessionData);let t=createSessionElemenet(e,currentVideoTitle,currentVideoImageURL);document.getElementById("session-list").appendChild(t),document.getElementById("session-container").style.display="block"})})}let visualizerInterval,sourceNode,gainNode,visualizer=new Visualizer("visualizer");function startVisuaizer(){visualizerInterval=setInterval(()=>{visualizer.paint(voiceRecorder.getFrequencyData().slice(5))},75)}function stopVisuaizer(){visualizer.paint([]),clearInterval(visualizerInterval)}function updateVoiceGain(){try{let e=document.getElementById("volumeSlider").value;gainNode.gain.value=e}catch(e){}}document.getElementById("btnReplay").onclick=(()=>{if(!document.getElementById("btnReplay").disabled)if(1!=videoPlayer.isPlaying){videoPlayer.playVideo(),videoPlayer.isPlaying=!0,document.getElementById("btnReplay").value="Stop Replay",showPlayer(),document.getElementById("btnStartStop").disabled=!0,document.getElementById("btnStartStop").style.backgroundColor="gainsboro";let e=setInterval(()=>{videoPlayer.getCurrentTime()>0&&(clearInterval(e),(sourceNode=audioContext.createBufferSource()).buffer=voiceAudioBuffer,(gainNode=audioContext.createGain()).gain.value=GAIN_PLAYBACK,sourceNode.connect(gainNode),gainNode.connect(audioContext.destination),sourceNode.start(),console.log("Replaying..."))},100);document.getElementById("volumeSlider").style.display="block"}else hidePlayer(),videoPlayer.stopVideo(),videoPlayer.isPlaying=!1,sourceNode.stop(),document.getElementById("btnReplay").value="Replay",document.getElementById("btnStartStop").disabled=!1,document.getElementById("btnStartStop").style.backgroundColor="red",document.getElementById("volumeSlider").style.display="none"});
